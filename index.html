<!DOCTYPE html>
<html>
<head>
    <title>Vessel Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <style>
        body { margin: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        /* The Search/Discovery Panel */
        #ui-panel {
            position: absolute;
            top: 10px; right: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            width: 300px;
        }
        input { width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box; }
        .stats { font-size: 0.9em; color: #555; margin-bottom: 10px; }
        .ship-list { max-height: 200px; overflow-y: auto; border-top: 1px solid #eee; }
        .ship-item { padding: 5px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .ship-item:hover { background: #f9f9f9; }
        .type-tag { font-size: 0.8em; background: #eee; padding: 2px 5px; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="ui-panel">
        <h3>Vessel Discovery</h3>
        <input type="text" id="search" placeholder="Search ship name..." />
        <div class="stats" id="stats">Loading ships...</div>
        <div class="ship-list" id="results"></div>
    </div>

    <div id="map"></div>

    <script>
        // 1. Initialize Map
        var map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        var allShips = [];
        var markers = L.layerGroup().addTo(map);
        var fuse; // The search engine instance

        // 2. Fetch Data
        fetch('ships.json')
            .then(res => res.json())
            .then(data => {
                allShips = data;
                
                // Initialize Search Engine (Fuse.js)
                fuse = new Fuse(allShips, {
                    keys: ['name', 'mmsi'], // Allow searching by Name or ID
                    threshold: 0.3          // 0.0 = perfect match, 1.0 = match anything
                });

                updateStats();
                renderMap(allShips);
            });

        // 3. Render Markers on Map
        function renderMap(shipsToRender) {
            markers.clearLayers();
            shipsToRender.forEach(ship => {
                var color = ship.type === 'Tanker' ? 'red' : 
                            ship.type === 'Cargo' ? 'green' : 'blue';
                            
                var circle = L.circleMarker([ship.lat, ship.lon], {
                    radius: 5,
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.7
                }).bindPopup(`<b>${ship.name}</b><br>Type: ${ship.type}<br>MMSI: ${ship.mmsi}`);
                
                markers.addLayer(circle);
            });
        }

        // 4. Update Statistics (Discovery Feature)
        function updateStats() {
            var counts = {};
            allShips.forEach(s => { counts[s.type] = (counts[s.type] || 0) + 1; });
            
            var statText = `Tracking <b>${allShips.length}</b> vessels.<br>`;
            for (var type in counts) {
                statText += `${type}: ${counts[type]} | `;
            }
            document.getElementById('stats').innerHTML = statText;
        }

        // 5. Handle Search Input
        document.getElementById('search').addEventListener('input', (e) => {
            var term = e.target.value;
            var resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            if (term.length < 2) {
                renderMap(allShips); // Show all if search is empty
                return;
            }

            // Perform fuzzy search
            var results = fuse.search(term);
            var filteredShips = results.map(r => r.item);

            // Update Map to only show matches
            renderMap(filteredShips);

            // Show list in the side panel
            results.slice(0, 5).forEach(r => {
                var div = document.createElement('div');
                div.className = 'ship-item';
                div.innerHTML = `<b>${r.item.name}</b> <span class="type-tag">${r.item.type}</span>`;
                div.onclick = () => {
                    map.setView([r.item.lat, r.item.lon], 10);
                    // Find the marker and open popup (advanced, simplified here)
                };
                resultsDiv.appendChild(div);
            });
        });
    </script>
</body>
</html>
