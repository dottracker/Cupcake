<!DOCTYPE html>
<html>
<head>
    <title>VesselScope</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        /* Side Panel */
        #ui-panel {
            position: absolute;
            top: 20px; right: 20px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: 280px;
        }
        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .stats { font-size: 0.85em; color: #666; margin-bottom: 10px; }
        .ship-list { max-height: 250px; overflow-y: auto; border-top: 1px solid #eee; }
        .ship-item { padding: 8px 5px; cursor: pointer; border-bottom: 1px solid #f5f5f5; font-size: 0.9em; }
        .ship-item:hover { background: #f0f7ff; }

        /* NEW: Last Updated Badge */
        #time-badge {
            position: absolute;
            bottom: 20px; left: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body>

    <div id="ui-panel">
        <h3 style="margin-top:0;">VesselScope</h3>
        <input type="text" id="search" placeholder="Search name or MMSI..." />
        <div class="stats" id="stats">Connecting...</div>
        <div class="ship-list" id="results"></div>
    </div>

    <!-- NEW: Time Display -->
    <div id="time-badge">Waiting for data...</div>

    <div id="map"></div>

    <script>
        var map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '© OpenStreetMap, © CartoDB'
        }).addTo(map);

        var allShips = [];
        var markers = L.layerGroup().addTo(map);
        var fuse;

        // LOAD DATA
        fetch('public/ships.json')
            .then(res => res.json())
            .then(data => {
                // 1. Handle the new data structure
                var updateTime = data.updated;
                allShips = data.ships; // The list is now inside .ships

                // 2. Update the Time Badge
                document.getElementById('time-badge').innerHTML = `Last Updated: ${updateTime}`;
                
                // 3. Initialize Search
                fuse = new Fuse(allShips, { keys: ['name', 'mmsi'], threshold: 0.3 });

                updateStats();
                renderMap(allShips);
            })
            .catch(err => console.error("Error loading ships:", err));

        function renderMap(shipsToRender) {
            markers.clearLayers();
            shipsToRender.forEach(ship => {
                var color = '#95a5a6'; // Default Gray
                if(ship.type_text.includes('Tanker')) color = '#e74c3c';
                else if(ship.type_text.includes('Cargo')) color = '#2ecc71';
                else if(ship.type_text.includes('Fishing')) color = '#f1c40f';
                else if(ship.type_text.includes('Passenger')) color = '#9b59b6';
                else if(ship.type_text.includes('Tug')) color = '#e67e22';

                // Popup Logic with Raw Code
                var popupContent = `
                    <div style="font-family:sans-serif;">
                        <h3 style="margin:0 0 5px 0;">${ship.name}</h3>
                        <div style="margin-bottom:8px;">
                            <span style="background:${color}; color:white; padding:2px 6px; border-radius:4px; font-size:0.8em;">
                                ${ship.type_text}
                            </span>
                            <span style="color:#666; font-size:0.8em; margin-left:5px;">
                                (Code: ${ship.type_code})
                            </span>
                        </div>
                        <div style="font-size:0.9em; line-height:1.4;">
                            <b>Speed:</b> ${ship.speed} kn <br>
                            <b>Dest:</b> ${ship.dest} <br>
                            <b>Size:</b> ${ship.len}m x ${ship.width}m
                        </div>
                        <div style="margin-top:8px; font-size:0.8em; text-align:right;">
                            <a href="https://www.vesselfinder.com/vessels/details/${ship.mmsi}" target="_blank">More Info ↗</a>
                        </div>
                    </div>
                `;

                L.circleMarker([ship.lat, ship.lon], {
                    radius: 5, color: 'white', weight: 1, 
                    fillColor: color, fillOpacity: 0.8
                }).bindPopup(popupContent).addTo(markers);
            });
        }

        function updateStats() {
            document.getElementById('stats').innerText = `Tracking ${allShips.length} vessels active now.`;
        }

        document.getElementById('search').addEventListener('input', (e) => {
            var term = e.target.value;
            var resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            if (term.length < 2) { renderMap(allShips); return; }

            var results = fuse.search(term).map(r => r.item);
            renderMap(results);

            results.slice(0, 10).forEach(ship => {
                var div = document.createElement('div');
                div.className = 'ship-item';
                div.innerHTML = `<b>${ship.name}</b> <small>(${ship.type_text})</small>`;
                div.onclick = () => {
                    map.setView([ship.lat, ship.lon], 10);
                };
                resultsDiv.appendChild(div);
            });
        });
    </script>
</body>
</html>
